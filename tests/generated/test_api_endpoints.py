"""Auto-generated API tests.

Generated by TestAgent for API Contract Enforcer.
"""

import uuid

import pytest
from httpx import AsyncClient, ASGITransport

from services.user_service.main import app


def unique_email(prefix: str = "test") -> str:
    """Generate a unique email address for testing."""
    return f"{prefix}_{uuid.uuid4().hex[:8]}@example.com"


@pytest.fixture
async def client():
    """Create async test client."""
    transport = ASGITransport(app=app)
    async with AsyncClient(transport=transport, base_url="http://test") as ac:
        yield ac

async def test_get_users(client: AsyncClient) -> None:
    """Test GET /users."""
    response = await client.get("/users")

    assert response.status_code == 200
    data = response.json()
    assert "users" in data
    assert "total" in data

async def test_post_users(client: AsyncClient) -> None:
    """Test POST /users."""
    payload = {
        "email": unique_email("post"),
        "name": "name_value",
    }
    response = await client.post("/users", json=payload)

    assert response.status_code == 201
    data = response.json()
    assert "id" in data
    assert "email" in data
    assert "name" in data
    assert "is_active" in data
    assert "created_at" in data

async def test_get_users_user_id(client: AsyncClient) -> None:
    """Test GET /users/{user_id}."""
    response = await client.get("/users/1")

    assert response.status_code == 200
    data = response.json()
    assert "id" in data
    assert "email" in data
    assert "name" in data
    assert "is_active" in data
    assert "created_at" in data

async def test_put_users_user_id(client: AsyncClient) -> None:
    """Test PUT /users/{user_id}."""
    # First create a user to update
    create_payload = {
        "email": unique_email("update"),
        "name": "Update Test User",
    }
    create_response = await client.post("/users", json=create_payload)
    assert create_response.status_code == 201
    user_id = create_response.json()["id"]

    # Now update the user
    payload = {
        "name": "Updated Name",
    }
    response = await client.put(f"/users/{user_id}", json=payload)

    assert response.status_code == 200
    data = response.json()
    assert "id" in data
    assert "email" in data
    assert "name" in data
    assert "is_active" in data
    assert "created_at" in data

async def test_delete_users_user_id(client: AsyncClient) -> None:
    """Test DELETE /users/{user_id}."""
    # First create a user to delete
    create_payload = {
        "email": unique_email("delete"),
        "name": "Delete Test User",
    }
    create_response = await client.post("/users", json=create_payload)
    assert create_response.status_code == 201
    user_id = create_response.json()["id"]

    # Now delete the user
    response = await client.delete(f"/users/{user_id}")

    assert response.status_code == 204
